<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- keep viewport for proper mobile scaling -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>HTML5 Interactive — xAPI Base + Phonogram Practice (mobile-friendly)</title>

  <!-- xAPI base scripts (UNCHANGED) -->
  <script>
    window.ACTIVITY_ID = "https://github.com/limkimsze-maker/consonants/blob/915c8b275fbde80b1a569ba601ab800869d6e313/ActivityID";
  </script>
  <script src="xapiwrapper.min.js"></script>
  <script src="index.js" defer></script>

  <!-- New-Session Clear Kit (UNCHANGED LOGIC) -->
  <script>
  (function (global){
    const Kit = {
      init(opts = {}) {
        const ACTIVITY_ID = String(opts.activityId || global.ACTIVITY_ID || location.href);
        const QS = new URLSearchParams(location.search);
        const salt = (typeof opts.scopeSalt === 'function') ? (opts.scopeSalt(QS) || '') : (opts.scopeSalt || '');
        const baseQS = QS.get('attempt') || QS.get('run') || QS.get('session') || QS.toString() || 'noqs';
        const CURR_SCOPE = `${ACTIVITY_ID}::${salt}::${baseQS}`;
        const SCOPE_KEY  = `sls_scope::${ACTIVITY_ID}`;
        const resetParam = opts.resetParam || 'reset';
        const FORCE = QS.has(resetParam) || QS.has('newSession');

        let prev = null;
        try { prev = localStorage.getItem(SCOPE_KEY); } catch (e) {}

        const isNew = FORCE || prev !== CURR_SCOPE;
        if (isNew) {
          if (opts.clickButtonId) {
            const btn = document.getElementById(opts.clickButtonId);
            if (btn) {
              try { btn.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true })); } catch (e) {}
            }
          }
          if (typeof opts.onNewSession === 'function') {
            try { opts.onNewSession(); } catch (e) {}
          }
          if (opts.pushZero !== false) {
            const payload = { score: 0 };
            try { if (typeof global.storeState === 'function') global.storeState(payload); } catch (e) {}
            try { if (typeof global.sendState  === 'function') global.sendState(payload);  } catch (e) {}
          }
          try { localStorage.setItem(SCOPE_KEY, CURR_SCOPE); } catch (e) {}
        }
        return { isNewAssignment: isNew, scope: CURR_SCOPE };
      }
    };
    global.NewSessionClearKit = Kit;
  })(window);
  </script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

  <style>
    /* ============= ROOT LAYOUT ============= */

    body {
      font-family: "Lexend", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
      background: #f6f7fb;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      /* allow vertical scroll on phone, avoid sideways scroll */
      overflow-x: hidden;
    }

    /* hidden teacher/xAPI panel (kept for SLS but not shown to pupils) */
    .container {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,.08);
      width: 590px;
      height: 470px;
      overflow: auto;
      display: none; /* hide by default for pupils / mobile */
    }
    #xapiBase { display: none; }

    /* main app shell */
    #practiceApp {
      width: 100%;
      max-width: 1200px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 16px 40px rgba(0,0,0,.08);
      padding: 16px 16px 80px; /* extra bottom padding so FAB/player won't cover content */
      box-sizing: border-box;
    }

    #practiceApp header {
      position: relative;
      display: grid;
      gap: 6px;
      margin-bottom: 12px;
    }
    #practiceApp header h1 {
      margin: 0;
      font-size: 20px;
      line-height: 1.2;
    }
    #practiceApp header p {
      margin: 0;
      color: #637083;
      font-size: 14px;
      line-height: 1.4;
    }

    /* Save status badge */
    #statusBadge {
      position: absolute;
      right: 0;
      top: 0;
      background: #0f172a;
      color: #fff;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.2;
      font-weight: 700;
      display: none;
      max-width: 65%;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }

    /* floating scoreboard (collapsible) */
    #scorePanel {
      position: fixed;
      right: 12px;
      bottom: 72px;
      z-index: 9999;
      box-sizing: border-box;
      font-size: 14px;
      line-height: 1.3;
      font-family: inherit;
      /* start hidden until showScorePanel(true) */
      display: none;
    }

    .scorePanel-collapsed {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 90px;
      max-width: 40vw;
      background: #0f172a;
      color: #fff;
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 800;
      font-size: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.4);
      border: 2px solid #0f172a;
      cursor: pointer;
      user-select: none;
    }

    .scorePanel-expanded {
      background: #fff;
      border: 2px solid #cfe1ff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12);
      width: min(300px, 80vw);
      max-height: 40vh;
      overflow-y: auto;
      display: grid;
      gap: 6px;
    }

    /* header row in expanded view */
    #scorePanel .sp-topline {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    #scorePanel .sp-head {
      font-weight: 900;
      font-size: 16px;
      margin: 0;
      color: #0f172a;
      line-height: 1.2;
    }

    .scorePanel-close {
      background: transparent;
      border: none;
      color: #64748b;
      font-size: 16px;
      line-height: 1;
      font-weight: 700;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 6px;
    }

    .scorePanel-close:active {
      background: #e2e8f0;
    }

    #scorePanel .sp-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    #scorePanel .sp-col h4 {
      margin: 0 0 6px;
      font-size: 14px;
      line-height: 1.2;
      font-weight: 700;
    }

    .sp-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 14px;
      line-height: 1;
    }
    .pill.good {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #bbf7d0;
    }
    .pill.bad {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    /* selector + database row
       desktop: 320px / 1fr
       mobile: stacked column */
    #selectRow {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      align-items: start;
    }

    /* left control column */
    .controls {
      display: grid;
      gap: 12px;
    }

    .control {
      background: #fff;
      border: 1px solid #e9eef7;
      border-radius: 14px;
      padding: 12px;
      box-sizing: border-box;
    }
    .control h3 {
      margin: 0 0 8px;
      font-size: 15px;
      line-height: 1.3;
    }
    .hint {
      color: #64748b;
      font-size: 12px;
      line-height: 1.4;
    }

    /* right column: big scrollable list */
    .panel {
      background: #fbfcff;
      border: 1px solid #e9eef7;
      border-radius: 14px;
      padding: 14px;
      max-height: 68vh;
      overflow-y: auto;
      box-sizing: border-box;
    }

    .cycles {
      display: grid;
      gap: 12px;
    }

    details {
      border: 1px solid #e9eef7;
      border-radius: 12px;
      background: #fff;
      padding: 10px 12px;
    }

    summary {
      cursor: pointer;
      font-weight: 800;
      color: #0f172a;
      font-size: 14px;
      line-height: 1.4;
    }

    .items {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }

    .row-small {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    /* Phonogram chips */
    label.badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      user-select: none;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: .1px;
      border: 1px solid #e1e5ee;
      color: #000;
      background: #fff;
      line-height: 1.2;
      font-size: 15px;
      min-height: 40px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      transition: box-shadow .2s ease, transform .05s ease;
    }
    label.badge input {
      transform: scale(1.2);
      margin-right: 2px;
      accent-color: #2563eb;
    }
    label.badge.pink {
      background: #ffdbe7;
      border-color: #ffc3d7;
      color: #000;
    }
    label.badge:active {
      transform: scale(.98);
      box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }

    /* Practice / Summary / Review cards */
    #practice {
      margin-top: 18px;
      display: none;
    }

    .practice-card {
      background: #fff;
      border: 1px solid #f1f1f4;
      border-radius: 18px;
      padding: 16px;
      display: grid;
      gap: 12px;
      justify-items: center;
      text-align: center;
      position: relative;
      box-sizing: border-box;
    }

    /* Big phonogram text */
    .pg {
      font-size: clamp(48px, 14vw, 126px);
      font-weight: 900;
      letter-spacing: 2px;
      padding: 8px 18px;
      border-radius: 14px;
      line-height: 1;
      color: #000;
      background: #fff;
    }
    .pg.pink {
      background: #ffdbe7;
      color: #000;
    }

    .pg-meta {
      font-size: 14px;
      color: #6b7280;
      margin-top: 2px;
      line-height: 1.3;
      text-align: center;
    }

    .progress {
      color: #64748b;
      font-size: 14px;
      line-height: 1.4;
    }

    /* buttons */
    .btn {
      appearance: none;
      border: none;
      cursor: pointer;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 800;
      color: #fff;
      font-size: 16px;
      line-height: 1.2;
    }
    .btn.small {
      padding: 10px 12px;
      font-size: 14px;
    }
    .btn.ok    { background: #16a34a; }
    .btn.warn  { background: #d97706; }
    .btn.danger{ background: #e11d48; }
    .btn.ghost {
      background: #fff;
      color: #2563eb;
      border: 1px solid #cfe1ff;
    }

    .note-sounds {
      color: #2563eb;
      font-weight: 700;
      font-size: 14px;
      line-height: 1.3;
      margin-top: 4px;
      text-align: center;
    }

    .summary,
    .review {
      display: none;
      margin-top: 18px;
    }

    .list {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chip {
      padding: 6px 10px;
      background: #111827;
      color: #fff;
      border-radius: 999px;
      font-size: 14px;
      line-height: 1.2;
      font-weight: 700;
    }

    .review-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(min(180px,45vw),1fr));
      gap: 12px;
    }
    .review-card {
      background: #fff;
      border: 1px solid #e9eef7;
      border-radius: 14px;
      padding: 12px;
      text-align: center;
      display: grid;
      gap: 10px;
      box-sizing: border-box;
    }
    .review-card .pg {
      font-size: clamp(40px, 10vw, 54px);
    }

    .muted {
      color: #6b7280;
      font-size: 14px;
      line-height: 1.4;
    }

    .hidden { display: none !important; }

    /* SLS instruction banner */
    .sls-banner {
      width: 100%;
      text-align: center;
      padding: 10px 12px;
      border-radius: 12px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1e3a8a;
      font-weight: 800;
      font-size: 14px;
      line-height: 1.4;
      box-sizing: border-box;
    }

    /* audio player anchored at bottom full-width on mobile */
    #player {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      max-width: 100%;
      background: #fff;
      border-top: 2px solid #cfe1ff;
      border-radius: 12px 12px 0 0;
      padding: 8px 12px 12px;
      box-sizing: border-box;
      z-index: 10000;
    }

    /* footer text */
    .footer {
      color: #64748b;
      font-size: 12px;
      line-height: 1.4;
    }

    /* ======== RESPONSIVE BREAKPOINTS ======== */

    @media (max-width: 768px) {
      /* stack the 2-column section into 1 column */
      #selectRow {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      /* pull status badge into flow on narrow screens so it doesn’t cover title */
      #statusBadge {
        position: static;
        max-width: 100%;
        margin-top: 6px;
      }

      /* make control cards thumb-friendly */
      .control h3 {
        font-size: 16px;
      }
      .btn {
        font-size: 15px;
      }
      input[type="number"],
      input[type="text"] {
        font-size: 16px;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        font-family: inherit;
      }
      label {
        font-size: 15px;
      }

      /* make panel scroll area shorter so header stays visible */
      .panel {
        max-height: 50vh;
      }

      /* scoreboard position/font in mobile */
      #scorePanel {
        bottom: 140px; /* keep above audio bar / iOS bar */
        font-size: 13px;
      }
      .scorePanel-expanded {
        width: min(260px, 90vw);
        max-height: 40vh;
        font-size: 13px;
      }
      #scorePanel .sp-head {
        font-size: 15px;
      }
      #scorePanel .sp-col h4 {
        font-size: 13px;
      }
      .pill {
        font-size: 13px;
        padding: 5px 8px;
      }
      .scorePanel-collapsed {
        font-size: 13px;
        min-width: 80px;
        padding: 9px 10px;
      }

      /* main heading smaller on very small width */
      #practiceApp header h1 {
        font-size: 18px;
      }

      /* yes/no/check row wraps nicely */
      .btns {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }
      .btns .btn {
        flex: 1 1 auto;
        min-width: 90px;
        text-align: center;
      }

      .practice-card {
        padding: 14px;
      }

      .pg-meta {
        font-size: 13px;
      }

      .progress {
        font-size: 13px;
      }

      .note-sounds {
        font-size: 13px;
      }

      .chip {
        font-size: 13px;
        padding: 6px 9px;
      }
    }

    @media (min-width: 769px) {
      body {
        align-items: flex-start;
      }
      #practiceApp {
        padding: 22px 22px 100px;
      }
    }

  </style>
</head>
<body>
  <!-- xAPI base (kept but hidden from pupils) -->
  <div id="xapiBase" class="container">
    <p class="center"><strong>HTML5 Interactive</strong></p>
    <div class="center">
      <label for="score-input">Score:</label>
      <input type="text" id="score-input" />
      <label for="feedback-input">Feedback:</label>
      <input type="text" id="feedback-input" placeholder="Enter feedback" />
    </div>
    <div id="criteria-container" class="center"></div>
    <div class="center">
      <button id="add-criteria-button">Add Rubric Criteria</button>
    </div>
    <div class="center">
      <button id="save-store">Send/Save</button>
      <button id="clear-inputs">Clear</button>
    </div>
    <div class="output-container">
      <pre id="result"></pre>
      <hr class="separator" />
      <pre id="getState"></pre>
      <hr class="separator" />
      <pre id="questionId"></pre>
      <pre id="userId"></pre>
      <pre id="cookieId"></pre>
      <a id="activityLink" href="https://github.com/limkimsze-maker/consonants/blob/915c8b275fbde80b1a569ba601ab800869d6e313/ActivityID" target="_blank" rel="noopener">ActivityID</a>
    </div>
  </div>

  <!-- Practice App -->
  <div id="practiceApp">
    <header>
      <h1>Sound Garden</h1>
      <p>Select cycles or phonograms, set order and length, then start practice. Tap <em>Check</em> to hear the sound, then choose <em>Yes</em> or <em>No</em>.</p>

      <div id="statusBadge" aria-live="polite"></div>

      <!-- Collapsible Score panel -->
      <aside id="scorePanel" aria-live="polite">
        <!-- Collapsed view (default) -->
        <div id="scorePanelCollapsed" class="scorePanel-collapsed" role="button" tabindex="0">
          Progress
        </div>

        <!-- Expanded view -->
        <div id="scorePanelExpanded" class="scorePanel-expanded" style="display:none;">
          <div class="sp-topline">
            <div class="sp-head">Practice progress</div>
            <button class="scorePanel-close" id="scorePanelCloseBtn" aria-label="Close score panel">✕</button>
          </div>

          <div class="sp-body">
            <div class="sp-col">
              <h4>✔ Correct (<span id="spRightCount">0</span>)</h4>
              <div id="spRight" class="sp-list"></div>
            </div>
            <div class="sp-col">
              <h4>✖ Incorrect (<span id="spWrongCount">0</span>)</h4>
              <div id="spWrong" class="sp-list"></div>
            </div>
          </div>
        </div>
      </aside>
    </header>

    <!-- Selection / setup row -->
    <div id="selectRow">
      <section class="controls">
        <div class="control">
          <h3>Order</h3>
          <div class="row-small">
            <label><input type="radio" name="order" value="sequence" checked> Sequence</label>
            <label><input type="radio" name="order" value="random"> Randomised</label>
          </div>
        </div>

        <div class="control">
          <h3>How many phonograms?</h3>
          <input type="number" id="countInput" min="1" value="10" />
          <div class="hint">If this exceeds the selected amount, it will be clamped automatically.</div>
        </div>

        <div class="control">
          <h3>Selection actions</h3>
          <div class="row-small">
            <button class="btn ghost small" id="selectAll">Select all</button>
            <button class="btn ghost small" id="clearAll">Clear all</button>
            <button class="btn ghost small" id="selectCyclesOnly">Select whole cycles</button>
          </div>
        </div>

        <div class="control">
          <h3>Start</h3>
          <div class="row-small">
            <button class="btn ok small" id="startBtn">Start practice</button>
            <button class="btn ghost small" id="resetBtn" disabled>Reset</button>
            <button class="btn warn small" id="newSessionBtn" type="button">New session (clear saved)</button>
          </div>
          <div class="hint">Badge shows how many are selected and which cycles.</div>
        </div>

        <div class="footer">
          © 2025 Lim Kim Sze. Audio courtesy of the Psychological Services Branch, Special Educational Needs Division, Ministry of Education (Singapore).
        </div>
      </section>

      <section class="panel">
        <h3 style="margin:4px 0 10px;font-size:15px;line-height:1.3;">Phonogram database (Cycles)</h3>
        <div class="cycles" id="cyclesHost"></div>

        <hr style="margin:14px 0; border-color:#eef2ff;" />

        <h3 style="margin:4px 0 10px;font-size:15px;line-height:1.3;">All phonograms (quick pick)</h3>
        <div class="items" id="allHost"></div>
      </section>
    </div>

    <!-- PRACTICE SCREEN -->
    <section id="practice" class="practice">
      <div class="practice-card">

        <!-- Top bar in practice -->
        <div style="width:100%;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:10px;">
          <button class="btn ghost small" id="backMainBtn" type="button">← Main page</button>

          <div class="sls-banner" role="note" style="flex:1 1 auto;min-width:180px;">
            When you have finished Sound Garden, <strong>return to SLS and tap “Submit”</strong> to record your score and lists.
          </div>
        </div>

        <div class="progress" id="progressTxt">—</div>
        <div class="pg" id="pgText">—</div>
        <div class="pg-meta" id="pgMeta">—</div>

        <div class="row-small" style="gap:8px;justify-content:center;">
          <span id="twoSoundNote" class="note-sounds hidden">(Note that there are 2 sounds)</span>
        </div>

        <div class="btns" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;width:100%;">
          <button class="btn small" style="background:#06b6d4;min-width:90px;" id="checkBtn" aria-label="Hear the correct sound">🔊 Check</button>
          <button class="btn ok small" style="min-width:90px;" id="yesBtn">Yes</button>
          <button class="btn danger small" style="min-width:90px;" id="noBtn">No</button>
        </div>
      </div>
    </section>

    <!-- SUMMARY SCREEN -->
    <section id="summary" class="summary">
      <div class="control">
        <h3>Session summary</h3>
        <p id="scoreLine"><strong>Score:</strong> —</p>
        <p class="muted" id="metaLine">—</p>

        <div id="wrongWrap" class="hidden">
          <h4 style="margin:12px 0 6px;font-size:15px;line-height:1.3;">Wrong phonograms</h4>
          <div id="wrongList" class="list"></div>
        </div>

        <div class="row-small" style="margin-top:10px;">
          <button id="reviewBtn" class="btn small" style="background:#3b82f6;">Review wrong items</button>
          <button id="restartBtn" class="btn ghost small">Start new practice</button>
        </div>
      </div>
    </section>

    <!-- REVIEW SCREEN -->
    <section id="review" class="review">
      <div class="control">
        <h3>Review: Words for the tricky phonograms</h3>

        <div class="sls-banner" role="note" style="margin:6px 0 10px;">
          After reviewing, <strong>go back to SLS and tap “Submit”</strong> to save your score and lists.
        </div>

        <p class="muted">Tap the phonogram or any word to hear it. Mark each as reviewed when you feel confident.</p>

        <div id="reviewGrid" class="review-grid"></div>

        <div class="row-small" style="margin-top:10px;justify-content:flex-end;">
          <button id="completeReviewBtn" class="btn ok small">Complete review</button>
          <button id="backToSummaryBtn" class="btn ghost small">Back to summary</button>
        </div>
      </div>
    </section>
  </div>

  <!-- pinned audio player at bottom so pupils can always replay -->
  <audio id="player" controls preload="auto" playsinline></audio>

  <script>
  (function(){
    const PAYLOAD_KEY = 'sls_phonogram_payload_v2';

    function pushToXAPI(score, feedback){
      try {
        const sInput = document.getElementById('score-input');
        const fInput = document.getElementById('feedback-input');
        if (sInput) sInput.value = score;
        if (fInput) fInput.value = feedback || '';
        if (typeof updateStore === 'function') { updateStore(); }
        else if (typeof storeState === 'function') { storeState({ score, feedback }); }

        const badge = document.getElementById('statusBadge');
        if (badge){
          badge.style.display='block';
          badge.textContent =
            `Saved for SLS · Score ${score}` +
            (feedback
              ? ' · ' + (feedback.length>40 ? (feedback.slice(0,40)+'…') : feedback)
              : '');
        }
      } catch(e) {}
    }

    function writePayload(score, feedback){
      try {
        localStorage.setItem(
          PAYLOAD_KEY,
          JSON.stringify({ score, feedback, t: Date.now() })
        );
      } catch(e){}
    }

    function readPayload(){
      try {
        const raw = localStorage.getItem(PAYLOAD_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch(e){ return null; }
    }

    function syncFromLocalStorageToXAPI(){
      const p = readPayload();
      if (!p) return;
      pushToXAPI(p.score, p.feedback);
    }

    window.addEventListener('load', () => { syncFromLocalStorageToXAPI(); });
    window.addEventListener('visibilitychange', () => { if (!document.hidden) syncFromLocalStorageToXAPI(); });
    window.addEventListener('focus', syncFromLocalStorageToXAPI);
    window.addEventListener('storage', (e)=>{ if (e.key === PAYLOAD_KEY && e.newValue) syncFromLocalStorageToXAPI(); });

    /* ======= Database (unchanged content) ======= */
    const DB = [
      { id: "C1S1", title: "C1S1: Review consonant and vowel graphs", items: ["a","e","i","o","u","b","c-hard","d","f","g-hard","h","j","k","l","m","n","p","qu","r","s","t","v","w","x","y","z"] },
      { id: "C1S2", title: "C1S2: Digraphs [ch, sh, th]", items: ["ch","sh","th"] },
      { id: "C2S1", title: "C2S1: Floss rule [-ff, -ll, -ss, -zz]", items: ["-ff","-ll","-ss","-zz"] },
      { id: "C2S2", title: "C2S2: -ck rule", items: ["-ck"] },
      { id: "C2S3", title: "C2S3: -tch rule", items: ["-tch"] },
      { id: "C3S1", title: "C3S1: -dge rule", items: ["dge"] },
      { id: "C3S2", title: "C3S2: Magic-e rule", items: ["a-e","e-e","i-e","o-e","u-e"] },
      { id: "C6S1", title: "C6S1: Consonant -le blends [-ble, -dle]", items: ["-ble","-dle"] },
      { id: "C6S2", title: "C6S2: Consonant -le blends [-ple, -tle, -gle]", items: ["-ple","-tle","-gle"] },
      { id: "C6S3", title: "C6S3: r-controlled vowels [ar, or]", items: ["ar","or"] },
      { id: "C7S1", title: "C7S1: r-controlled vowels [ir, er, ur]", items: ["ir","er","ur"] },
      { id: "C7S2", title: "C7S2: Vowel graphs [y_vowel_sounds]", items: ["y-vowel"] },
      { id: "C8S1", title: "C8S1: Soft ‘c’ & Soft ‘g’ rule", items: ["c-soft","g-soft"] },
      { id: "C8S2", title: "C8S2: Vowel teams [‘ay’, ‘ai’ say /ā/]", items: ["ai","ay"] },
      { id: "C9S1", title: "C9S1: Vowel team [‘ee’ says /ē/]", items: ["ee"] },
      { id: "C9S2", title: "C9S2: Vowel team [‘ea’ says /ĕ/ or /ē/]", items: ["ea-short-e","ea"] },
      { id: "C9S3", title: "C9S3: Vowel team [‘ie’ says /ī/ or /ē/]", items: ["ie"] },
      { id: "C10S1", title: "C10S1: Vowel team [‘ei’ says /ē/ or /ā/]", items: ["ei"] },
      { id: "C10S2", title: "C10S2: Vowel team [‘ey’ says /ā/ or /ē/]", items: ["ey"] },
      { id: "C11S1", title: "C11S1: Vowel teams [‘oa’, ‘ow’ says /ō/]", items: ["oa","ow-long-o"] },
      { id: "C11S2", title: "C11S2: Vowel team [‘oo’ — long & short sounds]", items: ["oo"] },
      { id: "C11S3", title: "C11S3: Vowel teams [‘ue’, ‘ew’, ‘ui’ say /oo/]", items: ["ue","ew","ui"] },
      { id: "C12S1", title: "C12S1: Vowel teams [‘ue’, ‘ew’ say /ū/]", items: ["ue-u","ew-u"] },
      { id: "C12S2", title: "C12S2: Vowel team [‘aw’ says /aw/]", items: ["aw"] },
      { id: "C13S1", title: "C13S1: Vowel teams [‘ou’, ‘ow’ say /ow/]", items: ["ou","ow"] },
      { id: "C13S2", title: "C13S2: Vowel team [‘oi’, ‘oy’ say /oi/]", items: ["oi","oy"] },
      { id: "C13S3", title: "C13S3: Vowel team [‘igh’ says /ī/]", items: ["igh"] },
      { id: "C14S1", title: "C14S1: Consonant digraph [‘kn’ says /n/]", items: ["kn"] },
      { id: "C14S2", title: "C14S2: Consonant digraph [‘ng’ says /ŋ/, ‘nk’ says /ŋk/]", items: ["ng","nk"] },
      { id: "C16S1", title: "C16S1: Plural suffixes ‘-s’ and ‘-es’", items: ["-s","-es"] },
      { id: "C16S2", title: "C16S2: Past Tense Suffix ‘-ed’", items: ["-ed"] },
      { id: "C16S3", title: "C16S3: Prefixes ‘un-’ and ‘in-'", items: ["un-","in-"] },
      { id: "C17S1", title: "C17S1: Suffixes ‘-ing’ and ‘-ful’", items: ["-ing","-ful"] },
      { id: "C17S2", title: "C17S2: Prefixes ‘re-’ and ‘dis-’", items: ["re-","dis-"] },
      { id: "C17S3", title: "C17S3: Comparative/ Superlative Suffixes ‘-er’ and ‘-est’", items: ["-er","-est"] },
      { id: "C18S1", title: "C18S1: Prefix ‘mis-’", items: ["mis-"] },
      { id: "C18S2", title: "C18S2: Prefix ‘pre-’", items: ["pre-"] },
      { id: "C18S3", title: "C18S3: Suffix ‘-less’", items: ["-less"] },
    ];

    /* Classification helpers */
    const VOWEL_TEAMS   = new Set(['ai','ay','ee','ea','ea-short-e','ie','ei','ey','oa','ow','oo','ue','ew','ui','aw','ou','oi','oy','igh','ow-long-o']);
    const VOWEL_SINGLES = new Set(['a','e','i','o','u','y-vowel']);
    const R_CONTROLLED  = new Set(['ar','or','ir','er','ur']);
    const MAGIC_E       = new Set(['a-e','e-e','i-e','o-e','u-e']);
    function isVowelPhonogram(item){
      return VOWEL_SINGLES.has(item)
          || VOWEL_TEAMS.has(item)
          || R_CONTROLLED.has(item)
          || MAGIC_E.has(item);
    }

    const TWO_SOUND_PHONOGRAMS   = new Set(['a','e','i','o','u','c','g','th','ie','ei','ey','y-vowel','oo']);
    const THREE_SOUND_PHONOGRAMS = new Set(['-ed']);

    const host        = document.getElementById('cyclesHost');
    const allHost     = document.getElementById('allHost');
    const statusBadge = document.getElementById('statusBadge');
    const CYCLE_TITLE = Object.fromEntries(DB.map(c => [c.id, c.title]));
    function makeId(cycleId, item){ return `${cycleId}::${item}`; }

    function chipClass(item){
      return (VOWEL_TEAMS.has(item) || MAGIC_E.has(item) || VOWEL_SINGLES.has(item) || R_CONTROLLED.has(item))
        ? 'pink' : '';
    }

    function renderDB(){
      host.innerHTML = '';
      const allSet = new Set();
      DB.forEach(({id, title, items})=>{
        const box = document.createElement('details'); box.open = true;

        const sum = document.createElement('summary');
        sum.textContent = `${id} — ${title}`;

        const actions = document.createElement('div');
        actions.className='row-small';
        actions.style.margin='6px 0 4px';
        actions.innerHTML = `
          <button class="btn ghost small" data-act="cycle-select" data-id="${id}">Select all in ${id}</button>
          <button class="btn ghost small" data-act="cycle-clear" data-id="${id}">Clear</button>
          <button class="btn small" style="background:#6366f1;color:#fff" data-act="review-to-here" data-id="${id}">Review to here</button>`;

        const itemsDiv = document.createElement('div');
        itemsDiv.className = 'items';

        items.forEach(it=>{
          allSet.add(it);
          const label = document.createElement('label');
          label.className = 'badge ' + chipClass(it);
          label.innerHTML = `<input type="checkbox" data-cycle="${id}" data-item="${it}" id="${makeId(id,it)}"> ${it}`;
          itemsDiv.appendChild(label);
        });

        box.append(sum, actions, itemsDiv);
        host.appendChild(box);
      });

      // quick pick all phonograms
      allHost.innerHTML = '';
      Array.from(allSet).sort().forEach(it=>{
        const label = document.createElement('label');
        label.className = 'badge ' + chipClass(it);
        label.innerHTML = `<input type="checkbox" data-cycle="*ANY*" data-item="${it}"> ${it}`;
        allHost.appendChild(label);
      });
    }
    renderDB();

    function selectThroughSession(targetId){
      const idx = DB.findIndex(s => s.id === targetId);
      if (idx < 0) return 0;
      document.querySelectorAll('#cyclesHost input[type="checkbox"]').forEach(cb => cb.checked = false);
      for (let i = 0; i <= idx; i++){
        const sess = DB[i];
        sess.items.forEach(it => {
          const el = document.getElementById(makeId(sess.id, it));
          if (el) el.checked = true;
        });
      }
      return document.querySelectorAll('#cyclesHost input[type="checkbox"]:checked').length;
    }

    function getSelected(){
      const checks = [...document.querySelectorAll('input[type="checkbox"]:checked')];
      const list = [];
      checks.forEach(ch=>{
        const cycle = ch.dataset.cycle;
        const item  = ch.dataset.item;
        if(cycle === '*ANY*'){
          const found = DB.find(c=>c.items.includes(item));
          list.push({t:item, c: found ? found.id : 'ALL'});
        } else {
          list.push({t:item, c: cycle});
        }
      });
      const seen = new Set();
      return list.filter(x=>{
        const key = x.t+'@@'+x.c;
        if(seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    function selectCycle(id, on=true){
      const cyc = DB.find(c=>c.id===id);
      if (!cyc) return;
      cyc.items.forEach(it=>{
        const el = document.getElementById(makeId(id,it));
        if(el) el.checked = !!on;
      });
    }

    // bulk selection buttons in the control panel
    document.getElementById('selectAll').onclick = (e)=>{
      e.preventDefault();
      document.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked = true);
    };

    document.getElementById('clearAll').onclick = (e)=>{
      e.preventDefault();
      document.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked = false);
    };

    document.getElementById('selectCyclesOnly').onclick = (e)=>{
      e.preventDefault();
      DB.forEach(c=>selectCycle(c.id,true));
    };

    host.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const act = btn.dataset.act;
      const id  = btn.dataset.id;
      if(act === 'cycle-select') selectCycle(id,true);
      if(act === 'cycle-clear')  selectCycle(id,false);
      if(act === 'review-to-here'){
        e.preventDefault();
        const total = selectThroughSession(id);
        const countInput = document.getElementById('countInput');
        if (countInput) countInput.value = total;
        startPractice();
      }
    });

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    const practiceEl   = document.getElementById('practice');
    const summaryEl    = document.getElementById('summary');
    const reviewEl     = document.getElementById('review');
    const progressTxt  = document.getElementById('progressTxt');
    const pgText       = document.getElementById('pgText');
    const pgMeta       = document.getElementById('pgMeta');
    const wrongListEl  = document.getElementById('wrongList');
    const wrongWrap    = document.getElementById('wrongWrap');
    const scoreLine    = document.getElementById('scoreLine');
    const metaLine     = document.getElementById('metaLine');
    const noteEl       = document.getElementById('twoSoundNote');
    const reviewGrid   = document.getElementById('reviewGrid');

    /* Scoreboard DOM refs */
    const spPanel           = document.getElementById('scorePanel');
    const spCollapsed       = document.getElementById('scorePanelCollapsed');
    const spExpanded        = document.getElementById('scorePanelExpanded');
    const spCloseBtn        = document.getElementById('scorePanelCloseBtn');
    const spRight           = document.getElementById('spRight');
    const spWrong           = document.getElementById('spWrong');
    const spRightCount      = document.getElementById('spRightCount');
    const spWrongCount      = document.getElementById('spWrongCount');

    function showScorePanel(show){
      if(!spPanel) return;
      if(show){
        // Show just the collapsed pill by default
        spPanel.style.display = 'block';
        spCollapsed.style.display = 'flex';
        spExpanded.style.display = 'none';
      } else {
        spPanel.style.display = 'none';
      }
    }

    function openScoreDetails(){
      spCollapsed.style.display = 'none';
      spExpanded.style.display = 'grid';
    }

    function closeScoreDetails(){
      spExpanded.style.display = 'none';
      spCollapsed.style.display = 'flex';
    }

    // tap the pill to expand
    spCollapsed.addEventListener('click', openScoreDetails);
    spCollapsed.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        openScoreDetails();
      }
    });

    // tap ✕ to collapse
    spCloseBtn.addEventListener('click', closeScoreDetails);

    function renderScorePanel(state){
      if(!state) return;
      const right = state.right || [];
      const wrong = state.wrong || [];

      spRightCount.textContent = right.length;
      spWrongCount.textContent = wrong.length;

      spRight.innerHTML = '';
      spWrong.innerHTML = '';

      right.forEach(({t})=>{
        const el = document.createElement('span');
        el.className='pill good';
        el.textContent = t;
        spRight.appendChild(el);
      });

      wrong.forEach(({t})=>{
        const el = document.createElement('span');
        el.className='pill bad';
        el.textContent = t;
        spWrong.appendChild(el);
      });
    }

    let STATE = null;
    let hasChecked = false;

    function startPractice(){
      const sel = getSelected();
      if(sel.length === 0){
        alert('Pick at least 1 phonogram.');
        return;
      }

      const order = document.querySelector('input[name="order"]:checked').value;
      const count = parseInt(document.getElementById('countInput').value || '1', 10);
      const arr   = order === 'random' ? shuffle(sel) : sel.slice();
      const limited = arr.slice(0, clamp(count,1,arr.length));
      const cyclesUsed = [...new Set(limited.map(x=>x.c))];

      STATE = {
        queue: limited,
        idx: 0,
        wrong: [],
        right: [],
        startedAt: Date.now(),
        order,
        cyclesUsed
      };

      const badge = document.getElementById('statusBadge');
      badge.style.display = 'block';
      badge.textContent = `${limited.length} phonograms • ${cyclesUsed.join(', ')}`;

      document.getElementById('selectRow').classList.add('hidden');
      practiceEl.style.display = 'block';
      document.getElementById('resetBtn').disabled = false;

      showScorePanel(true);
      renderScorePanel(STATE);

      pushToXAPI(0, '');
      writePayload(0, '');

      showCurrent();
      // scroll to practice card on small screens
      practiceEl.scrollIntoView({behavior:"smooth", block:"start"});
    }

    function setYN(enabled){
      document.getElementById('yesBtn').disabled = !enabled;
      document.getElementById('noBtn').disabled  = !enabled;
    }

    function showCurrent(){
      const {queue, idx} = STATE;
      const total   = queue.length;
      const curr    = queue[idx];
      const item    = curr.t;
      const cycleId = curr.c;

      progressTxt.textContent = `Item ${idx+1} of ${total}`;
      pgText.textContent = item;

      const title = CYCLE_TITLE[cycleId] || '';
      pgMeta.textContent = cycleId ? `${cycleId} — ${title}` : '—';

      const makePink = isVowelPhonogram(item);
      pgText.classList.toggle('pink', makePink);

      if (THREE_SOUND_PHONOGRAMS.has(item)) {
        noteEl.textContent = '(Note that there are 3 sounds)';
        noteEl.classList.remove('hidden');
      } else if (TWO_SOUND_PHONOGRAMS.has(item)) {
        noteEl.textContent = '(Note that there are 2 sounds)';
        noteEl.classList.remove('hidden');
      } else {
        noteEl.classList.add('hidden');
      }

      hasChecked = false;
      setYN(false);
    }

    function nextItem(correct){
      const item = STATE.queue[STATE.idx];
      (correct ? STATE.right : STATE.wrong).push(item);
      renderScorePanel(STATE);

      STATE.idx++;
      if(STATE.idx >= STATE.queue.length){
        endSession();
      } else {
        showCurrent();
      }
    }

    /* Build clearly-labelled feedback for SLS */
    function buildFeedback(state){
      const total   = state.queue.length;
      const correct = state.right.map(x=>x.t);
      const wrong   = state.wrong.map(x=>x.t);

      const lines = [
        `Score ${correct.length}/${total}`,
        `Correct: ${correct.length ? correct.join(', ') : '(none)'}`,
        `Incorrect: ${wrong.length ? wrong.join(', ') : '(none)'}`
      ];
      return lines.join(' | ');
    }

    function endSession(){
      practiceEl.style.display = 'none';
      summaryEl.style.display = 'block';

      const total    = STATE.queue.length;
      const correctN = STATE.right.length;
      const wrong    = STATE.wrong.map(x=>x.t);

      scoreLine.innerHTML =
        `<strong>Score:</strong> ${correctN} / ${total}` +
        (wrong.length===0
          ? ' — <span style="color:#059669;">Perfect!</span>'
          : '');

      metaLine.textContent =
        `Order: ${STATE.order}; Cycles: ${STATE.cyclesUsed.join(', ')}; `
        + `Duration: ${Math.round((Date.now()-STATE.startedAt)/1000)}s.`;

      if(wrong.length){
        wrongWrap.classList.remove('hidden');
        wrongListEl.innerHTML = '';
        wrong.forEach(w=>{
          const chip = document.createElement('div');
          chip.className='chip';
          chip.textContent = w;
          wrongListEl.appendChild(chip);
        });
      } else {
        wrongWrap.classList.add('hidden');
      }

      // push clearly-labelled lists into SLS feedback
      const feedbackText = buildFeedback(STATE);
      pushToXAPI(1, feedbackText);
      writePayload(1, feedbackText);

      renderScorePanel(STATE);

      // hide scoreboard during summary so it doesn't cover summary UI
      showScorePanel(false);

      summaryEl.scrollIntoView({behavior:"smooth", block:"start"});
    }

    document.getElementById('startBtn').onclick = startPractice;

    document.getElementById('resetBtn').onclick = ()=>{
      if(confirm('Reset selection?')){
        location.reload();
      }
    };

    document.getElementById('newSessionBtn').addEventListener('click', ()=>{
      writePayload(0, '');
      pushToXAPI(0, '');
      alert('Saved score/feedback cleared. Start a new practice when ready.');
    });

    document.getElementById('checkBtn').onclick = ()=>{
      playPhonogramSound(STATE.queue[STATE.idx].t);
      hasChecked = true;
      setYN(true);
    };

    document.getElementById('yesBtn').onclick = ()=>{
      if(!hasChecked){
        alert('Press 🔊 Check first.');
        return;
      }
      nextItem(true);
    };

    document.getElementById('noBtn').onclick = ()=>{
      if(!hasChecked){
        alert('Press 🔊 Check first.');
        return;
      }
      nextItem(false);
    };

    document.getElementById('restartBtn').onclick = ()=>{
      writePayload(0, '');
      pushToXAPI(0, '');
      location.reload();
    };

    /* Back to main (selection) */
    document.getElementById('backMainBtn').onclick = ()=>{
      if(STATE && STATE.idx < (STATE.queue?.length || 0)){
        const go = confirm('Return to main selection? Your current practice will be paused.');
        if(!go) return;
      }
      practiceEl.style.display='none';
      summaryEl.style.display='none';
      reviewEl.style.display='none';
      document.getElementById('selectRow').classList.remove('hidden');

      // hide scoreboard in selection
      showScorePanel(false);

      // scroll to top of selection controls
      document.getElementById('practiceApp').scrollIntoView({behavior:"smooth", block:"start"});
    };

    /* Review words */
    const REVIEW_WORDS = {
      "a": ["ant","apple","map"], "e": ["egg","ten","bed"], "i": ["ink","pin","sit"],
      "o": ["ox","hot","mop"], "u": ["up","sun","bus"],
      "b": ["bat","bag","bug"], "c-hard": ["cat","cup","cob"], "d": ["dog","dig","mud"],
      "f": ["fan","fig","puff"], "g-hard": ["gap","gob","gum"], "h": ["hat","hop","hut"],
      "j": ["jam","jug","jet"], "k": ["kit","kid","kiss"], "l": ["lip","log","bell"],
      "m": ["map","mug","ram"], "n": ["net","nap","tin"], "p": ["pen","pig","cup"],
      "qu": ["quit","quiz","quick"], "r": ["red","ram","rug"], "s": ["sun","sap","hiss"],
      "t": ["tap","ten","ant"], "v": ["van","vet","give"], "w": ["win","wet","wag"],
      "x": ["box","mix","fix"], "y": ["yam","yes","yell"], "z": ["zip","zoo","buzz"],
      "ch": ["chip","chess","lunch"], "sh": ["ship","shop","fish"], "th": ["thin","math","path"],
      "-ff": ["staff","cliff","sniff"], "-ll": ["bell","hill","shell"], "-ss": ["kiss","mess","class"], "-zz": ["buzz","fizz"],
      "-ck": ["back","duck","sock"], "-tch": ["match","batch","witch"],
      "dge": ["badge","fudge","ledge"],
      "a-e": ["cake","late","name"], "e-e": ["these","eve","theme"], "i-e": ["kite","time","ride"],
      "o-e": ["home","nose","stone"], "u-e": ["cube","tune","flute"],
      "-ble": ["table","cable","fable"], "-dle": ["candle","meddle","puddle"],
      "-ple": ["apple","purple","people"], "-tle": ["little","bottle","settle"], "-gle": ["juggle","giggle","eagle"],
      "ar": ["car","farm","star"], "or": ["fork","corn","storm"], "ir": ["bird","stir","shirt"],
      "er": ["her","fern","term"], "ur": ["fur","curl","turn"],
      "y-vowel": ["my","cry","fly"],
      "c-soft": ["cent","city","ice"], "g-soft": ["giraffe","gem","giant"],
      "ai": ["rain","train","snail"], "ay": ["day","play","tray"],
      "ee": ["see","tree","feet"], "ea": ["sea","bead","team"], "ea-short-e": ["bread","head","meant"],
      "ie": ["pie","tie","field"], "ei": ["ceiling","receive","vein"], "ey": ["key","monkey","honey"],
      "oa": ["boat","goat","road"], "ow-long-o": ["snow","slow","show"], "ow": ["cow","down","brown"],
      "oo": ["moon","food","book"], "ue": ["blue","true","glue"], "ew": ["chew","stew","grew"], "ui": ["fruit","suit","juice"],
      "ue-u": ["cue","due","rescue"], "ew-u": ["few","new","pew"],
      "aw": ["saw","claw","straw"], "ou": ["out","loud","mouse"], "oi": ["coin","boil","point"], "oy": ["boy","toy","joy"],
      "igh": ["night","light","sight"],
      "-s": ["cats","dogs","hats"], "-es": ["boxes","wishes","dishes"],
      "-ed": ["landed","jumped","played"], "-ing": ["running","singing","hitting"], "-ful": ["helpful","joyful","careful"],
      "un-": ["unhappy","untie","undo"], "in-": ["inside","incomplete","indirect"],
      "re-": ["redo","return","replay"], "dis-": ["dislike","disconnect","disagree"],
      "-er": ["bigger","faster","taller"], "-est": ["biggest","fastest","tallest"],
      "kn": ["knee","knife","knock"], "ng": ["song","ring","sing"], "nk": ["bank","sink","thank"],
      "mis-": ["misread","misplace","misuse"], "pre-": ["preview","preheat","prepay"], "-less": ["hopeless","fearless","restless"]
    };

    let REVIEW_LOG = {};

    function openReview(){
      const wrong = STATE?.wrong?.map(x=>x.t) || [];
      if(!wrong.length){
        alert('Nothing to review. Great job!');
        return;
      }

      reviewGrid.innerHTML = '';
      wrong.forEach(t=>{
        if(!REVIEW_LOG[t]) REVIEW_LOG[t] = { reviewed:false, playsPG:0, words:{} };

        const card = document.createElement('div');
        card.className = 'review-card';

        const big = document.createElement('div');
        big.className = 'pg' + (isVowelPhonogram(t) ? ' pink' : '');
        big.textContent = t;

        const row = document.createElement('div');
        row.className = 'row-small';
        row.style.justifyContent = 'center';

        const btnPG = document.createElement('button');
        btnPG.className = 'btn small';
        btnPG.style.background = '#06b6d4';
        btnPG.textContent = '🔊 Phonogram';
        btnPG.onclick = ()=>{
          playPhonogramSound(t);
          REVIEW_LOG[t].playsPG++;
        };

        const wordsWrap = document.createElement('div');
        const words = REVIEW_WORDS[t] || [];
        if(words.length){
          const wordsRow = document.createElement('div');
          wordsRow.className = 'row-small';
          wordsRow.style.justifyContent = 'center';
          words.forEach(w=>{
            const wb = document.createElement('button');
            wb.className = 'btn ghost small';
            wb.textContent = `🔊 ${w}`;
            wb.onclick = ()=>{
              playWordSound(w);
              REVIEW_LOG[t].words[w] = (REVIEW_LOG[t].words[w]||0)+1;
            };
            wordsRow.appendChild(wb);
          });
          wordsWrap.appendChild(wordsRow);
        } else {
          const none = document.createElement('div');
          none.className = 'muted';
          none.textContent = 'No word examples available';
          wordsWrap.appendChild(none);
        }

        const markBtn = document.createElement('button');
        markBtn.className = 'btn ok small';
        markBtn.textContent = '✓ Mark as reviewed';
        markBtn.onclick = ()=>{
          REVIEW_LOG[t].reviewed = true;
          markBtn.disabled = true;
          markBtn.textContent = 'Reviewed';
        };

        row.appendChild(btnPG);
        card.append(big, row, wordsWrap, markBtn);
        reviewGrid.appendChild(card);
      });

      summaryEl.style.display = 'none';
      reviewEl.style.display = 'block';

      showScorePanel(true); // collapsed pill again
      renderScorePanel(STATE);

      reviewEl.scrollIntoView({behavior:"smooth", block:"start"});
    }

    document.getElementById('reviewBtn').onclick = ()=> openReview();

    document.getElementById('backToSummaryBtn')?.addEventListener('click', ()=>{
      reviewEl.style.display='none';
      summaryEl.style.display='block';
      showScorePanel(false); // hide scoreboard on Summary
      summaryEl.scrollIntoView({behavior:"smooth", block:"start"});
    });

    document.getElementById('completeReviewBtn')?.addEventListener('click', ()=>{
      reviewEl.style.display='none';
      summaryEl.style.display='block';
      showScorePanel(false);
      alert('Review completed. You can close this window or start a new practice.');
      summaryEl.scrollIntoView({behavior:"smooth", block:"start"});
    });

    /* Audio handling */
    const AUDIO_BASE = 'audio/';
    const WORD_BASE  = 'audio/words/';
    const AUDIO_EXTS = ['mp3','m4a','mp4','wav','ogg'];
    const FILE_ALIASES = {};

    function sanitizePhonogramName(item){
      const raw = (FILE_ALIASES[item] ?? item);
      return raw.replace(/[^a-zA-Z0-9-]+/g,'');
    }
    function sanitizeWord(w){
      return w.toLowerCase().replace(/[^a-z]/g,'');
    }

    async function playViaPlayer(paths){
      const player = document.getElementById('player');
      for(const p of paths){
        try {
          player.pause();
          player.currentTime = 0;
          player.src = p;
          await player.play();
          return true;
        } catch(e){}
      }
      return false;
    }

    async function playPhonogramSound(item){
      const name = sanitizePhonogramName(item);
      const candidates = AUDIO_EXTS.map(ext => `${AUDIO_BASE}${name}.${ext}`);
      const ok = await playViaPlayer(candidates);
      if(!ok) speak(item);
    }

    async function playWordSound(word){
      const name = sanitizeWord(word);
      const candidates = AUDIO_EXTS.map(ext => `${WORD_BASE}${name}.${ext}`);
      const ok = await playViaPlayer(candidates);
      if(!ok) speak(word);
    }

    function speak(text){
      const synth = window.speechSynthesis;
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate  = 0.95;
      utter.pitch = 1.0;
      synth.cancel();
      synth.speak(utter);
    }
  })();
  </script>

  <!-- Initialize New-Session Clear Kit -->
  <script>
    window.addEventListener('load', () => {
      NewSessionClearKit.init({
        activityId: window.ACTIVITY_ID,
        clickButtonId: 'newSessionBtn',
        pushZero: false
      });
    });
  </script>
</body>
</html>
